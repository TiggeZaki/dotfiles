#!/bin/bash

set -e

# Core packages required at the system level
core_pkgs=(zsh vim git gnupg)

# Developer tools, often installed via user-level managers
devtools_pkgs=(sheldon starship eza fzf)

# Packages specific to the local host machine (non-container)
local_pkgs=(curl wget wl-clipboard)

install_apt() {
  sudo apt-get install -y --no-install-recommends "$@"
}

install_pacman() {
  sudo pacman -Syu --noconfirm --needed "$@"
}

install_brew() {
  if command -v brew >/dev/null 2>&1; then
    for pkg in "$@"; do
      brew install "$pkg"
    done
  fi
}

safe_ln() {
  if [ ! -e "$2" ]; then
    ln -s "$1" "$2"
  fi
}

main() {
  {{ $id := .chezmoi.osRelease.id }}
  {{ if eq $id "arch" }}
    pkgs=("${core_pkgs[@]}" "${devtools_pkgs[@]}")
    {{ if ne (env "REMOTE_CONTAINERS") "true" }}
      pkgs+=("${local_pkgs[@]}")
    {{ end }}
    install_pacman "${pkgs[@]}"
  {{ else if eq $id "debian" }}
    sudo apt update
    install_apt "${core_pkgs[@]}"
    install_brew "${devtools_pkgs[@]}"
    {{ if ne (env "REMOTE_CONTAINERS") "true" }}
      install_apt "${local_pkgs[@]}"
    {{ end }}
  {{ else }}
    echo "Unsupported distro: {{ $id }}"
    exit 1
  {{ end }}

  # WSL-specific tweaks, outside of tmpl block since it runs on both distros
  {{ if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}
    USERPROFILE="/mnt/c/Users/"$(basename $HOME)

    safe_ln "$USERPROFILE/Downloads" "$HOME/Downloads"
    mkdir -p "$HOME/.local/bin"
    safe_ln "$USERPROFILE/AppData/Local/Programs/Microsoft VS Code/bin/code" "$HOME/.local/bin/code"
  {{ end }}
}

main

