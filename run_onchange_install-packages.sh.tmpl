#!/bin/bash

set -e

# Core packages required at the system level
core_pkgs=(zsh vim curl file git gnupg)

# Developer tools, often installed via user-level managers
devtools_pkgs=(sheldon starship eza fzf)

# Packages specific to the local host machine (non-container)
local_pkgs=(wget wl-clipboard)

install_apt() {
  sudo apt-get update
  sudo apt-get install -y --no-install-recommends "$@"
}

install_pacman() {
  sudo pacman -Syu --noconfirm --needed "$@"
}

install_brew() {
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  for pkg in "$@"; do
    brew install "$pkg"
  done
}

safe_ln() {
  if [ ! -e "$2" ]; then
    ln -s "$1" "$2"
  fi
}

main() {
  {{ $id := .chezmoi.osRelease.id }}
  {{ if eq $id "arch" }}
    local pkgs=("${core_pkgs[@]}" "${devtools_pkgs[@]}")
    {{ if not .isContainer }}
      pkgs+=("${local_pkgs[@]}")
    {{ end }}
    install_pacman "${pkgs[@]}"
  {{ else if eq $id "debian" }}
    local pkgs=("${core_pkgs[@]}" "build-essential" "procps")
    {{ if not .isContainer }}
      pkgs+=("${local_pkgs[@]}")
    {{ end }}
    sudo apt update
    install_apt "${core_pkgs[@]}"
    install_brew "${devtools_pkgs[@]}"
  {{ else }}
    echo "Unsupported distro: {{ $id }}"
    exit 1
  {{ end }}

  # WSL-specific tweaks, outside of tmpl block since it runs on both distros
  {{ if and .isWsl (not .isContainer) }}
    USERPROFILE="/mnt/c/Users/"$(basename $HOME)

    safe_ln "$USERPROFILE/Downloads" "$HOME/Downloads"
    mkdir -p "$HOME/.local/bin"
    safe_ln "$USERPROFILE/AppData/Local/Programs/Microsoft VS Code/bin/code" "$HOME/.local/bin/code"
  {{ end }}
}

main

